<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ‹¬ç™»éŒ²ãƒ„ãƒ¼ãƒ«</title>
</head>
<body style="padding: 20px; font-family: sans-serif;">
    <h3><span style="color: #06c755;">â– </span> Firestore ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ‹¬ç™»éŒ²ãƒ„ãƒ¼ãƒ«</h3>
    <p>ä»¥ä¸‹ã®æ ã«JSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œä¸€æ‹¬ç™»éŒ²ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    
    <textarea id="json-input" rows="15" style="width: 100%; max-width: 600px; font-family: monospace;">
[
  { "id": "u071", "name": "æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼1", "group": "A", "role": "member", "icon": "ğŸ¶" },
  { "id": "u072", "name": "æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼2", "group": "A", "role": "member", "icon": "ğŸ±" }
]
    </textarea><br><br>
    
    <button id="import-btn" style="padding: 10px 20px; background-color: #06c755; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ä¸€æ‹¬ç™»éŒ²ã™ã‚‹</button>
    
    <div id="log" style="margin-top: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; max-width: 600px;"></div>

    <script type="module">
        // ã„ã¤ã‚‚ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        import { db } from "./js/firebase-config.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        document.getElementById('import-btn').addEventListener('click', async () => {
            const btn = document.getElementById('import-btn');
            const log = document.getElementById('log');
            
            try {
                const jsonStr = document.getElementById('json-input').value;
                const users = JSON.parse(jsonStr); // æ–‡å­—åˆ—ã‚’ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
                
                if(!confirm(`${users.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                btn.disabled = true;
                log.innerHTML = "ç™»éŒ²é–‹å§‹...<br>";

                // é †ç•ªã«Firestoreã¸æ›¸ãè¾¼ã¿
                for (const user of users) {
                    if(!user.id) continue;
                    const userRef = doc(db, "users", user.id);
                    await setDoc(userRef, user, { merge: true }); // ä¸Šæ›¸ãï¼†è¿½åŠ 
                    log.innerHTML += `âœ… ${user.name} (${user.id}) ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚<br>`;
                }
                
                log.innerHTML += "<br><b style='color:green;'>ğŸ‰ ã™ã¹ã¦ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</b>";
            } catch(e) {
                alert("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + e.message);
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>